name: Multi-Platform Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact_name: lsy_work
            asset_name: lsy_work-linux-x64
          - os: macos-latest
            artifact_name: lsy_work
            asset_name: lsy_work-macos-x64
          - os: windows-latest
            artifact_name: lsy_work.exe
            asset_name: lsy_work-windows-x64.exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.20.x'

    - name: Setup MinGW
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make

    - name: Configure CMake (Unix)
      if: runner.os != 'Windows'
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -G "MinGW Makefiles"
      shell: msys2 {0}

    - name: Build
      run: |
        cd build
        cmake --build . --config Release

    - name: Run Tests (Unix)
      if: runner.os != 'Windows'
      run: |
        cd build
        ctest -C Release -V

    - name: Run Tests (Windows)
      if: runner.os == 'Windows'
      run: |
        cd build
        ctest -C Release -V
      continue-on-error: true
      shell: msys2 {0}

    - name: Package artifacts (Unix)
      if: runner.os != 'Windows'
      run: |
        cd build
        mkdir -p release
        cp lsy_work release/${{ matrix.asset_name }}
        tar -czf ${{ matrix.asset_name }}.tar.gz -C release .

    - name: Package artifacts (Windows)
      if: runner.os == 'Windows'
      run: |
        cd build
        mkdir release
        cp lsy_work.exe release/${{ matrix.asset_name }}
        tar -czf ${{ matrix.asset_name }}.tar.gz -C release .
      shell: msys2 {0}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: ${{ matrix.asset_name }}
        path: build/${{ matrix.asset_name }}.tar.gz
        retention-days: 30

    - name: Upload executable
      uses: actions/upload-artifact@v6
      with:
        name: executable-${{ matrix.os }}
        path: build/release/${{ matrix.asset_name }}
        retention-days: 30

#  create-release:
#    name: Create Release
#    needs: build
#    runs-on: ubuntu-latest
#    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#
#    steps:
#    - name: Download all artifacts
#      uses: actions/download-artifact@v3
#      with:
#        path: ./artifacts
#
#    - name: Display structure of downloaded files
#      run: ls -R ./artifacts
#
#    - name: Get current date
#      id: date
#      run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

#    - name: Create Release
#      uses: softprops/action-gh-release@v1
#      with:
#        tag_name: build-${{ steps.date.outputs.date }}
#        name: Auto Build ${{ steps.date.outputs.date }}
#        body: |
#          自动构建版本
#
#          ## 构建信息
#          - 构建时间: ${{ steps.date.outputs.date }}
#          - 提交: ${{ github.sha }}
#          - 分支: ${{ github.ref }}
#
#          ## 包含平台
#          - ✅ Linux (x64)
#          - ✅ macOS (x64)
#          - ✅ Windows (x64)
#
#          ## 使用说明
#          1. 下载对应平台的可执行文件
#          2. Linux/macOS: 添加执行权限 `chmod +x lsy_work-*`
#          3. 直接运行程序
#        files: ./artifacts/*
#        draft: false
#        prerelease: false
#      env:
#        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
